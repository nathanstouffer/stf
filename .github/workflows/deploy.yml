name: deploy
on:
  push:
    branches: ["stouffer/host-docs"] # TODO (stouff) change this to main
    tags:
      - "v*.*.*"

permissions:
  contents: write

jobs:
  docs:
    runs-on: ubuntu-24.04

    steps:
      - name: checkout
        uses: actions/checkout@v3

      - name: Install Doxygen
        run: sudo apt-get install doxygen graphviz -y

      - name: Configure CMake
        run: cmake -B ${{ github.workspace }}/build -S ${{ github.workspace }}

      - name: Generate docs
        run: cmake --build ${{ github.workspace }}/build --target docs

      - name: Deploy docs
        run: |
          git fetch origin gh-pages
          git checkout gh-pages
          rm -rf docs/dev
          mkdir -p docs
          mkdir -p docs/dev
          cp -r docs/generated/html/* docs/dev
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add docs/dev
          if [ -z "$(git status --porcelain)" ]; then
            echo "Exiting -- nothing is staged."
          else
            echo "Staged files -- deploying"
            git commit -m 'Deploy docs for ${{ github.ref }}'
            git push
          fi

